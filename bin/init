#!/usr/bin/env php
<?php

require_once __DIR__ . '/../vendor/autoload.php';

function getArgs(): array
{
    global $argv;
    $result = [];
    foreach ($argv as $arg) {
        if (str_contains($arg, '=')) {
            [$key, $value] = explode('=', $arg);
            $result[$key] = $value;
        } else {
            $result[$arg] = true;
        }
    }
    return $result;
}

if (array_key_exists('--force', getArgs())) {
    $choice = 'y';
} else {
    $choice = readline('This script will remove your records in the database. Are you agree? [y/n]: ');
}

if ($choice !== 'y') {
    echo "OK. \n";
    exit;
}

if (file_exists(__DIR__ . '/../var/requests.db')) {
    unlink(__DIR__ . '/../var/requests.db');
    echo "Database removed\n";
}

$db = new \SQLite3(__DIR__ . '/../var/requests.db', SQLITE3_OPEN_CREATE | SQLITE3_OPEN_READWRITE);
$db->enableExceptions(true);

$createTablesSql = file_get_contents(__DIR__ . '/../database/init_sqlite.sql');
$parts = explode(';', $createTablesSql);
foreach ($parts as $part) {
    $db->query($part);
}
echo "Created table requests\n";
